<!doctype html><html lang=zh-CN dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content=' 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 func Init(mode string) (err error) { //读取配置中的logger信息,并进行配置 //Lumberjack Logger采用以下属性作为输入: // //Filename: 日志文件的位置 //MaxSize：在进行切割之前，日志文件的最大大小（以MB为单位） //MaxBackups：保留旧文件的最大个数 //MaxAges：保留旧文件的最大天数 //Compress：是否压缩/归档旧文件 writeSynced := getLogWriter( settings.Conf.LogConfig.Filename, settings.Conf.LogConfig.MaxSize, settings.Conf.LogConfig.MaxBackups, settings.Conf.LogConfig.MaxAge, ) //这是一个 zapcore.Encoder 类型的参数，负责将日志级别的数据（如日志消息、键值对等）编码成字节流。 encoder := getEncoder() //定义一下日志级别 //Zap 支持多种日志级别，包括 Debug、Info、Warn、Error、DPanic、Panic 和 Fatal var l = new(zapcore.Level) err = l.UnmarshalText([]byte(settings.Conf.LogConfig.Level)) if err != nil { fmt.Printf("UnmarshalText err:%v\\n", err) return } var core zapcore.Core if mode == "dev" { //开发模式，日主输出到终端 consoleEncoder := zapcore.NewConsoleEncoder(zap.NewDevelopmentEncoderConfig()) //日志输出位置，定为俩个 core = zapcore.NewTee( //日志文件 zapcore.NewCore(encoder, writeSynced, l), //打印到终端 zapcore.NewCore(consoleEncoder, zapcore.Lock(os.Stdout), zapcore.DebugLevel), ) } else { core = zapcore.NewCore(encoder, writeSynced, l) } //创建一个新的zap日志记录器 lg := zap.New(core, zap.AddCaller()) //替换zap库中全局的logger //在主函数中使用zap.L()调用全局的logger zap.ReplaceGlobals(lg) return } //将其更改为josn编码模式，将日志改为已读的年月日形式 func getEncoder() zapcore.Encoder { encoderConfig := zap.NewProductionEncoderConfig() encoderConfig.EncodeTime = zapcore.ISO8601TimeEncoder encoderConfig.TimeKey = "time" encoderConfig.EncodeLevel = zapcore.CapitalLevelEncoder encoderConfig.EncodeDuration = zapcore.SecondsDurationEncoder encoderConfig.EncodeCaller = zapcore.ShortCallerEncoder return zapcore.NewJSONEncoder(encoderConfig) } //保存配置信息，并返回一个日志生成器 func getLogWriter(filename string, maxSize, maxBackup, maxAge int) zapcore.WriteSyncer { lumberJackLogger := &amp;lumberjack.Logger{ Filename: filename, MaxSize: maxSize, MaxBackups: maxBackup, MaxAge: maxAge, } return zapcore.AddSync(lumberJackLogger) } // GinLogger 接收gin框架默认的日志 func GinLogger() gin.HandlerFunc { return func(c *gin.Context) { start := time.Now() path := c.Request.URL.Path query := c.Request.URL.RawQuery c.Next() cost := time.Since(start) zap.L().Info(path, zap.Int("status", c.Writer.Status()), zap.String("method", c.Request.Method), zap.String("path", path), zap.String("query", query), zap.String("ip", c.ClientIP()), zap.String("user-agent", c.Request.UserAgent()), zap.String("errors", c.Errors.ByType(gin.ErrorTypePrivate).String()), zap.Duration("cost", cost), ) } } // GinRecovery recover掉项目可能出现的panic，并使用zap记录相关日志 func GinRecovery(stack bool) gin.HandlerFunc { return func(c *gin.Context) { defer func() { if err := recover(); err != nil { // Check for a broken connection, as it is not really a // condition that warrants a panic stack trace. var brokenPipe bool if ne, ok := err.(*net.OpError); ok { if se, ok := ne.Err.(*os.SyscallError); ok { if strings.Contains(strings.ToLower(se.Error()), "broken pipe") || strings.Contains(strings.ToLower(se.Error()), "connection reset by peer") { brokenPipe = true } } } httpRequest, _ := httputil.DumpRequest(c.Request, false) if brokenPipe { zap.L().Error(c.Request.URL.Path, zap.Any("error", err), zap.String("request", string(httpRequest)), ) // If the connection is dead, we can&#39;t write a status to it. c.Error(err.(error)) // nolint: errcheck c.Abort() return } if stack { zap.L().Error("[Recovery from panic]", zap.Any("error", err), zap.String("request", string(httpRequest)), zap.String("stack", string(debug.Stack())), ) } else { zap.L().Error("[Recovery from panic]", zap.Any("error", err), zap.String("request", string(httpRequest)), ) } c.AbortWithStatus(http.StatusInternalServerError) } }() c.Next() } } '><title>zap日志库</title><link rel=canonical href=https://yuxiay.github.io/p/zap%E6%97%A5%E5%BF%97%E5%BA%93/><link rel=stylesheet href=/scss/style.min.946cca6c6259ef94ac55abfae7c7bf3291ea3ed5eea17ef77500b257217c6710.css><meta property='og:title' content="zap日志库"><meta property='og:description' content=' 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 func Init(mode string) (err error) { //读取配置中的logger信息,并进行配置 //Lumberjack Logger采用以下属性作为输入: // //Filename: 日志文件的位置 //MaxSize：在进行切割之前，日志文件的最大大小（以MB为单位） //MaxBackups：保留旧文件的最大个数 //MaxAges：保留旧文件的最大天数 //Compress：是否压缩/归档旧文件 writeSynced := getLogWriter( settings.Conf.LogConfig.Filename, settings.Conf.LogConfig.MaxSize, settings.Conf.LogConfig.MaxBackups, settings.Conf.LogConfig.MaxAge, ) //这是一个 zapcore.Encoder 类型的参数，负责将日志级别的数据（如日志消息、键值对等）编码成字节流。 encoder := getEncoder() //定义一下日志级别 //Zap 支持多种日志级别，包括 Debug、Info、Warn、Error、DPanic、Panic 和 Fatal var l = new(zapcore.Level) err = l.UnmarshalText([]byte(settings.Conf.LogConfig.Level)) if err != nil { fmt.Printf("UnmarshalText err:%v\\n", err) return } var core zapcore.Core if mode == "dev" { //开发模式，日主输出到终端 consoleEncoder := zapcore.NewConsoleEncoder(zap.NewDevelopmentEncoderConfig()) //日志输出位置，定为俩个 core = zapcore.NewTee( //日志文件 zapcore.NewCore(encoder, writeSynced, l), //打印到终端 zapcore.NewCore(consoleEncoder, zapcore.Lock(os.Stdout), zapcore.DebugLevel), ) } else { core = zapcore.NewCore(encoder, writeSynced, l) } //创建一个新的zap日志记录器 lg := zap.New(core, zap.AddCaller()) //替换zap库中全局的logger //在主函数中使用zap.L()调用全局的logger zap.ReplaceGlobals(lg) return } //将其更改为josn编码模式，将日志改为已读的年月日形式 func getEncoder() zapcore.Encoder { encoderConfig := zap.NewProductionEncoderConfig() encoderConfig.EncodeTime = zapcore.ISO8601TimeEncoder encoderConfig.TimeKey = "time" encoderConfig.EncodeLevel = zapcore.CapitalLevelEncoder encoderConfig.EncodeDuration = zapcore.SecondsDurationEncoder encoderConfig.EncodeCaller = zapcore.ShortCallerEncoder return zapcore.NewJSONEncoder(encoderConfig) } //保存配置信息，并返回一个日志生成器 func getLogWriter(filename string, maxSize, maxBackup, maxAge int) zapcore.WriteSyncer { lumberJackLogger := &amp;lumberjack.Logger{ Filename: filename, MaxSize: maxSize, MaxBackups: maxBackup, MaxAge: maxAge, } return zapcore.AddSync(lumberJackLogger) } // GinLogger 接收gin框架默认的日志 func GinLogger() gin.HandlerFunc { return func(c *gin.Context) { start := time.Now() path := c.Request.URL.Path query := c.Request.URL.RawQuery c.Next() cost := time.Since(start) zap.L().Info(path, zap.Int("status", c.Writer.Status()), zap.String("method", c.Request.Method), zap.String("path", path), zap.String("query", query), zap.String("ip", c.ClientIP()), zap.String("user-agent", c.Request.UserAgent()), zap.String("errors", c.Errors.ByType(gin.ErrorTypePrivate).String()), zap.Duration("cost", cost), ) } } // GinRecovery recover掉项目可能出现的panic，并使用zap记录相关日志 func GinRecovery(stack bool) gin.HandlerFunc { return func(c *gin.Context) { defer func() { if err := recover(); err != nil { // Check for a broken connection, as it is not really a // condition that warrants a panic stack trace. var brokenPipe bool if ne, ok := err.(*net.OpError); ok { if se, ok := ne.Err.(*os.SyscallError); ok { if strings.Contains(strings.ToLower(se.Error()), "broken pipe") || strings.Contains(strings.ToLower(se.Error()), "connection reset by peer") { brokenPipe = true } } } httpRequest, _ := httputil.DumpRequest(c.Request, false) if brokenPipe { zap.L().Error(c.Request.URL.Path, zap.Any("error", err), zap.String("request", string(httpRequest)), ) // If the connection is dead, we can&#39;t write a status to it. c.Error(err.(error)) // nolint: errcheck c.Abort() return } if stack { zap.L().Error("[Recovery from panic]", zap.Any("error", err), zap.String("request", string(httpRequest)), zap.String("stack", string(debug.Stack())), ) } else { zap.L().Error("[Recovery from panic]", zap.Any("error", err), zap.String("request", string(httpRequest)), ) } c.AbortWithStatus(http.StatusInternalServerError) } }() c.Next() } } '><meta property='og:url' content='https://yuxiay.github.io/p/zap%E6%97%A5%E5%BF%97%E5%BA%93/'><meta property='og:site_name' content='yuxiay的博客'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='go'><meta property='article:published_time' content='2024-09-03T20:04:06+08:00'><meta property='article:modified_time' content='2024-09-03T20:04:06+08:00'><meta name=twitter:title content="zap日志库"><meta name=twitter:description content=' 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 func Init(mode string) (err error) { //读取配置中的logger信息,并进行配置 //Lumberjack Logger采用以下属性作为输入: // //Filename: 日志文件的位置 //MaxSize：在进行切割之前，日志文件的最大大小（以MB为单位） //MaxBackups：保留旧文件的最大个数 //MaxAges：保留旧文件的最大天数 //Compress：是否压缩/归档旧文件 writeSynced := getLogWriter( settings.Conf.LogConfig.Filename, settings.Conf.LogConfig.MaxSize, settings.Conf.LogConfig.MaxBackups, settings.Conf.LogConfig.MaxAge, ) //这是一个 zapcore.Encoder 类型的参数，负责将日志级别的数据（如日志消息、键值对等）编码成字节流。 encoder := getEncoder() //定义一下日志级别 //Zap 支持多种日志级别，包括 Debug、Info、Warn、Error、DPanic、Panic 和 Fatal var l = new(zapcore.Level) err = l.UnmarshalText([]byte(settings.Conf.LogConfig.Level)) if err != nil { fmt.Printf("UnmarshalText err:%v\\n", err) return } var core zapcore.Core if mode == "dev" { //开发模式，日主输出到终端 consoleEncoder := zapcore.NewConsoleEncoder(zap.NewDevelopmentEncoderConfig()) //日志输出位置，定为俩个 core = zapcore.NewTee( //日志文件 zapcore.NewCore(encoder, writeSynced, l), //打印到终端 zapcore.NewCore(consoleEncoder, zapcore.Lock(os.Stdout), zapcore.DebugLevel), ) } else { core = zapcore.NewCore(encoder, writeSynced, l) } //创建一个新的zap日志记录器 lg := zap.New(core, zap.AddCaller()) //替换zap库中全局的logger //在主函数中使用zap.L()调用全局的logger zap.ReplaceGlobals(lg) return } //将其更改为josn编码模式，将日志改为已读的年月日形式 func getEncoder() zapcore.Encoder { encoderConfig := zap.NewProductionEncoderConfig() encoderConfig.EncodeTime = zapcore.ISO8601TimeEncoder encoderConfig.TimeKey = "time" encoderConfig.EncodeLevel = zapcore.CapitalLevelEncoder encoderConfig.EncodeDuration = zapcore.SecondsDurationEncoder encoderConfig.EncodeCaller = zapcore.ShortCallerEncoder return zapcore.NewJSONEncoder(encoderConfig) } //保存配置信息，并返回一个日志生成器 func getLogWriter(filename string, maxSize, maxBackup, maxAge int) zapcore.WriteSyncer { lumberJackLogger := &amp;lumberjack.Logger{ Filename: filename, MaxSize: maxSize, MaxBackups: maxBackup, MaxAge: maxAge, } return zapcore.AddSync(lumberJackLogger) } // GinLogger 接收gin框架默认的日志 func GinLogger() gin.HandlerFunc { return func(c *gin.Context) { start := time.Now() path := c.Request.URL.Path query := c.Request.URL.RawQuery c.Next() cost := time.Since(start) zap.L().Info(path, zap.Int("status", c.Writer.Status()), zap.String("method", c.Request.Method), zap.String("path", path), zap.String("query", query), zap.String("ip", c.ClientIP()), zap.String("user-agent", c.Request.UserAgent()), zap.String("errors", c.Errors.ByType(gin.ErrorTypePrivate).String()), zap.Duration("cost", cost), ) } } // GinRecovery recover掉项目可能出现的panic，并使用zap记录相关日志 func GinRecovery(stack bool) gin.HandlerFunc { return func(c *gin.Context) { defer func() { if err := recover(); err != nil { // Check for a broken connection, as it is not really a // condition that warrants a panic stack trace. var brokenPipe bool if ne, ok := err.(*net.OpError); ok { if se, ok := ne.Err.(*os.SyscallError); ok { if strings.Contains(strings.ToLower(se.Error()), "broken pipe") || strings.Contains(strings.ToLower(se.Error()), "connection reset by peer") { brokenPipe = true } } } httpRequest, _ := httputil.DumpRequest(c.Request, false) if brokenPipe { zap.L().Error(c.Request.URL.Path, zap.Any("error", err), zap.String("request", string(httpRequest)), ) // If the connection is dead, we can&#39;t write a status to it. c.Error(err.(error)) // nolint: errcheck c.Abort() return } if stack { zap.L().Error("[Recovery from panic]", zap.Any("error", err), zap.String("request", string(httpRequest)), zap.String("stack", string(debug.Stack())), ) } else { zap.L().Error("[Recovery from panic]", zap.Any("error", err), zap.String("request", string(httpRequest)), ) } c.AbortWithStatus(http.StatusInternalServerError) } }() c.Next() } } '><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_b33ac33d040797db.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>🍥</span></figure><div class=site-meta><h1 class=site-name><a href=/>yuxiay的博客</a></h1><h2 class=site-description>偷得浮生半日闲</h2></div></header><ol class=menu-social><li><a href=https://github.com target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com target=_blank title=Twitter rel=me><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/go/>Go</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/zap%E6%97%A5%E5%BF%97%E5%BA%93/>zap日志库</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Sep 03, 2024</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 2 分钟</time></div></footer></div></header><section class=article-content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>Init</span><span class=p>(</span><span class=nx>mode</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=nx>err</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=cp>//读取配置中的logger信息,并进行配置</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=cp>//Lumberjack Logger采用以下属性作为输入:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1>	//Filename: 日志文件的位置</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=cp>//MaxSize：在进行切割之前，日志文件的最大大小（以MB为单位）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=cp>//MaxBackups：保留旧文件的最大个数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=cp>//MaxAges：保留旧文件的最大天数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=cp>//Compress：是否压缩/归档旧文件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>writeSynced</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>getLogWriter</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>settings</span><span class=p>.</span><span class=nx>Conf</span><span class=p>.</span><span class=nx>LogConfig</span><span class=p>.</span><span class=nx>Filename</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>settings</span><span class=p>.</span><span class=nx>Conf</span><span class=p>.</span><span class=nx>LogConfig</span><span class=p>.</span><span class=nx>MaxSize</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>settings</span><span class=p>.</span><span class=nx>Conf</span><span class=p>.</span><span class=nx>LogConfig</span><span class=p>.</span><span class=nx>MaxBackups</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>settings</span><span class=p>.</span><span class=nx>Conf</span><span class=p>.</span><span class=nx>LogConfig</span><span class=p>.</span><span class=nx>MaxAge</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cp>//这是一个 zapcore.Encoder 类型的参数，负责将日志级别的数据（如日志消息、键值对等）编码成字节流。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>encoder</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>getEncoder</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cp>//定义一下日志级别</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cp>//Zap 支持多种日志级别，包括 Debug、Info、Warn、Error、DPanic、Panic 和 Fatal</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>var</span><span class=w> </span><span class=nx>l</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>new</span><span class=p>(</span><span class=nx>zapcore</span><span class=p>.</span><span class=nx>Level</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>err</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>l</span><span class=p>.</span><span class=nf>UnmarshalText</span><span class=p>([]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>settings</span><span class=p>.</span><span class=nx>Conf</span><span class=p>.</span><span class=nx>LogConfig</span><span class=p>.</span><span class=nx>Level</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;UnmarshalText err:%v\n&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>var</span><span class=w> </span><span class=nx>core</span><span class=w> </span><span class=nx>zapcore</span><span class=p>.</span><span class=nx>Core</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>mode</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=s>&#34;dev&#34;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=cp>//开发模式，日主输出到终端</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>consoleEncoder</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>zapcore</span><span class=p>.</span><span class=nf>NewConsoleEncoder</span><span class=p>(</span><span class=nx>zap</span><span class=p>.</span><span class=nf>NewDevelopmentEncoderConfig</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=cp>//日志输出位置，定为俩个</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>core</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>zapcore</span><span class=p>.</span><span class=nf>NewTee</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=cp>//日志文件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>zapcore</span><span class=p>.</span><span class=nf>NewCore</span><span class=p>(</span><span class=nx>encoder</span><span class=p>,</span><span class=w> </span><span class=nx>writeSynced</span><span class=p>,</span><span class=w> </span><span class=nx>l</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=cp>//打印到终端</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>zapcore</span><span class=p>.</span><span class=nf>NewCore</span><span class=p>(</span><span class=nx>consoleEncoder</span><span class=p>,</span><span class=w> </span><span class=nx>zapcore</span><span class=p>.</span><span class=nf>Lock</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nx>Stdout</span><span class=p>),</span><span class=w> </span><span class=nx>zapcore</span><span class=p>.</span><span class=nx>DebugLevel</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>core</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>zapcore</span><span class=p>.</span><span class=nf>NewCore</span><span class=p>(</span><span class=nx>encoder</span><span class=p>,</span><span class=w> </span><span class=nx>writeSynced</span><span class=p>,</span><span class=w> </span><span class=nx>l</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=cp>//创建一个新的zap日志记录器</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>lg</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>zap</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>core</span><span class=p>,</span><span class=w> </span><span class=nx>zap</span><span class=p>.</span><span class=nf>AddCaller</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=cp>//替换zap库中全局的logger</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=cp>//在主函数中使用zap.L()调用全局的logger</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>zap</span><span class=p>.</span><span class=nf>ReplaceGlobals</span><span class=p>(</span><span class=nx>lg</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>//将其更改为josn编码模式，将日志改为已读的年月日形式</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>getEncoder</span><span class=p>()</span><span class=w> </span><span class=nx>zapcore</span><span class=p>.</span><span class=nx>Encoder</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>encoderConfig</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>zap</span><span class=p>.</span><span class=nf>NewProductionEncoderConfig</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>encoderConfig</span><span class=p>.</span><span class=nx>EncodeTime</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>zapcore</span><span class=p>.</span><span class=nx>ISO8601TimeEncoder</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>encoderConfig</span><span class=p>.</span><span class=nx>TimeKey</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=s>&#34;time&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>encoderConfig</span><span class=p>.</span><span class=nx>EncodeLevel</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>zapcore</span><span class=p>.</span><span class=nx>CapitalLevelEncoder</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>encoderConfig</span><span class=p>.</span><span class=nx>EncodeDuration</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>zapcore</span><span class=p>.</span><span class=nx>SecondsDurationEncoder</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>encoderConfig</span><span class=p>.</span><span class=nx>EncodeCaller</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>zapcore</span><span class=p>.</span><span class=nx>ShortCallerEncoder</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=nx>zapcore</span><span class=p>.</span><span class=nf>NewJSONEncoder</span><span class=p>(</span><span class=nx>encoderConfig</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>//保存配置信息，并返回一个日志生成器</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>getLogWriter</span><span class=p>(</span><span class=nx>filename</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>maxSize</span><span class=p>,</span><span class=w> </span><span class=nx>maxBackup</span><span class=p>,</span><span class=w> </span><span class=nx>maxAge</span><span class=w> </span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=nx>zapcore</span><span class=p>.</span><span class=nx>WriteSyncer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>lumberJackLogger</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>lumberjack</span><span class=p>.</span><span class=nx>Logger</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>Filename</span><span class=p>:</span><span class=w>   </span><span class=nx>filename</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>MaxSize</span><span class=p>:</span><span class=w>    </span><span class=nx>maxSize</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>MaxBackups</span><span class=p>:</span><span class=w> </span><span class=nx>maxBackup</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>MaxAge</span><span class=p>:</span><span class=w>     </span><span class=nx>maxAge</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=nx>zapcore</span><span class=p>.</span><span class=nf>AddSync</span><span class=p>(</span><span class=nx>lumberJackLogger</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// GinLogger 接收gin框架默认的日志</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>GinLogger</span><span class=p>()</span><span class=w> </span><span class=nx>gin</span><span class=p>.</span><span class=nx>HandlerFunc</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=kd>func</span><span class=p>(</span><span class=nx>c</span><span class=w> </span><span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>start</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>path</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>Request</span><span class=p>.</span><span class=nx>URL</span><span class=p>.</span><span class=nx>Path</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>query</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>Request</span><span class=p>.</span><span class=nx>URL</span><span class=p>.</span><span class=nx>RawQuery</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>c</span><span class=p>.</span><span class=nf>Next</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>cost</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nf>Since</span><span class=p>(</span><span class=nx>start</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>zap</span><span class=p>.</span><span class=nf>L</span><span class=p>().</span><span class=nf>Info</span><span class=p>(</span><span class=nx>path</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>zap</span><span class=p>.</span><span class=nf>Int</span><span class=p>(</span><span class=s>&#34;status&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>Writer</span><span class=p>.</span><span class=nf>Status</span><span class=p>()),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>zap</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=s>&#34;method&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>Request</span><span class=p>.</span><span class=nx>Method</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>zap</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=s>&#34;path&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>path</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>zap</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=s>&#34;query&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>query</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>zap</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=s>&#34;ip&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nf>ClientIP</span><span class=p>()),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>zap</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=s>&#34;user-agent&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>Request</span><span class=p>.</span><span class=nf>UserAgent</span><span class=p>()),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>zap</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=s>&#34;errors&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>Errors</span><span class=p>.</span><span class=nf>ByType</span><span class=p>(</span><span class=nx>gin</span><span class=p>.</span><span class=nx>ErrorTypePrivate</span><span class=p>).</span><span class=nf>String</span><span class=p>()),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>zap</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=s>&#34;cost&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>cost</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// GinRecovery recover掉项目可能出现的panic，并使用zap记录相关日志</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>GinRecovery</span><span class=p>(</span><span class=nx>stack</span><span class=w> </span><span class=kt>bool</span><span class=p>)</span><span class=w> </span><span class=nx>gin</span><span class=p>.</span><span class=nx>HandlerFunc</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=kd>func</span><span class=p>(</span><span class=nx>c</span><span class=w> </span><span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>defer</span><span class=w> </span><span class=kd>func</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>recover</span><span class=p>();</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=c1>// Check for a broken connection, as it is not really a</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=c1>// condition that warrants a panic stack trace.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=kd>var</span><span class=w> </span><span class=nx>brokenPipe</span><span class=w> </span><span class=kt>bool</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>if</span><span class=w> </span><span class=nx>ne</span><span class=p>,</span><span class=w> </span><span class=nx>ok</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>err</span><span class=p>.(</span><span class=o>*</span><span class=nx>net</span><span class=p>.</span><span class=nx>OpError</span><span class=p>);</span><span class=w> </span><span class=nx>ok</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=k>if</span><span class=w> </span><span class=nx>se</span><span class=p>,</span><span class=w> </span><span class=nx>ok</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>ne</span><span class=p>.</span><span class=nx>Err</span><span class=p>.(</span><span class=o>*</span><span class=nx>os</span><span class=p>.</span><span class=nx>SyscallError</span><span class=p>);</span><span class=w> </span><span class=nx>ok</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>						</span><span class=k>if</span><span class=w> </span><span class=nx>strings</span><span class=p>.</span><span class=nf>Contains</span><span class=p>(</span><span class=nx>strings</span><span class=p>.</span><span class=nf>ToLower</span><span class=p>(</span><span class=nx>se</span><span class=p>.</span><span class=nf>Error</span><span class=p>()),</span><span class=w> </span><span class=s>&#34;broken pipe&#34;</span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=nx>strings</span><span class=p>.</span><span class=nf>Contains</span><span class=p>(</span><span class=nx>strings</span><span class=p>.</span><span class=nf>ToLower</span><span class=p>(</span><span class=nx>se</span><span class=p>.</span><span class=nf>Error</span><span class=p>()),</span><span class=w> </span><span class=s>&#34;connection reset by peer&#34;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>							</span><span class=nx>brokenPipe</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>						</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nx>httpRequest</span><span class=p>,</span><span class=w> </span><span class=nx>_</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>httputil</span><span class=p>.</span><span class=nf>DumpRequest</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>Request</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>if</span><span class=w> </span><span class=nx>brokenPipe</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=nx>zap</span><span class=p>.</span><span class=nf>L</span><span class=p>().</span><span class=nf>Error</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>Request</span><span class=p>.</span><span class=nx>URL</span><span class=p>.</span><span class=nx>Path</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>						</span><span class=nx>zap</span><span class=p>.</span><span class=nf>Any</span><span class=p>(</span><span class=s>&#34;error&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>						</span><span class=nx>zap</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=s>&#34;request&#34;</span><span class=p>,</span><span class=w> </span><span class=nb>string</span><span class=p>(</span><span class=nx>httpRequest</span><span class=p>)),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=c1>// If the connection is dead, we can&#39;t write a status to it.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=nx>c</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>.(</span><span class=kt>error</span><span class=p>))</span><span class=w> </span><span class=c1>// nolint: errcheck</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=nx>c</span><span class=p>.</span><span class=nf>Abort</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>if</span><span class=w> </span><span class=nx>stack</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=nx>zap</span><span class=p>.</span><span class=nf>L</span><span class=p>().</span><span class=nf>Error</span><span class=p>(</span><span class=s>&#34;[Recovery from panic]&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>						</span><span class=nx>zap</span><span class=p>.</span><span class=nf>Any</span><span class=p>(</span><span class=s>&#34;error&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>						</span><span class=nx>zap</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=s>&#34;request&#34;</span><span class=p>,</span><span class=w> </span><span class=nb>string</span><span class=p>(</span><span class=nx>httpRequest</span><span class=p>)),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>						</span><span class=nx>zap</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=s>&#34;stack&#34;</span><span class=p>,</span><span class=w> </span><span class=nb>string</span><span class=p>(</span><span class=nx>debug</span><span class=p>.</span><span class=nf>Stack</span><span class=p>())),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=nx>zap</span><span class=p>.</span><span class=nf>L</span><span class=p>().</span><span class=nf>Error</span><span class=p>(</span><span class=s>&#34;[Recovery from panic]&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>						</span><span class=nx>zap</span><span class=p>.</span><span class=nf>Any</span><span class=p>(</span><span class=s>&#34;error&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>						</span><span class=nx>zap</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=s>&#34;request&#34;</span><span class=p>,</span><span class=w> </span><span class=nb>string</span><span class=p>(</span><span class=nx>httpRequest</span><span class=p>)),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nx>c</span><span class=p>.</span><span class=nf>AbortWithStatus</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>c</span><span class=p>.</span><span class=nf>Next</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></section><footer class=article-footer><section class=article-tags><a href=/tags/go/>Go</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/etcd%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/><div class=article-details><h2 class=article-title>etcd原理与应用</h2></div></a></article><article><a href=/p/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E7%90%86%E8%A7%A3rpc/><div class=article-details><h2 class=article-title>从0开始理解rpc</h2></div></a></article><article><a href=/p/validator%E5%8F%82%E6%95%B0%E6%A3%80%E9%AA%8C/><div class=article-details><h2 class=article-title>validator参数检验</h2></div></a></article><article><a href=/p/go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/><div class=article-details><h2 class=article-title>go并发编程</h2></div></a></article><article><a href=/p/gin-swagger%E5%BA%93/><div class=article-details><h2 class=article-title>gin-swagger库</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//hugo-theme-stack.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2025 yuxiay的博客</section><section class=powerby>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>