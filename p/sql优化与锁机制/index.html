<!doctype html><html lang=zh-CN dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="SQL优化与锁机制 SQL优化 通过SQL语句前加入explain进行分析\n1 explain + 正常sql语句 explain内容分析：\nexplain结构分析 id\nid值越大，先执行\nid值相同，从上往下执行\n"><title>SQL优化与锁机制</title><link rel=canonical href=https://yuxiay.github.io/p/sql%E4%BC%98%E5%8C%96%E4%B8%8E%E9%94%81%E6%9C%BA%E5%88%B6/><link rel=stylesheet href=/scss/style.min.946cca6c6259ef94ac55abfae7c7bf3291ea3ed5eea17ef77500b257217c6710.css><meta property='og:title' content="SQL优化与锁机制"><meta property='og:description' content="SQL优化与锁机制 SQL优化 通过SQL语句前加入explain进行分析\n1 explain + 正常sql语句 explain内容分析：\nexplain结构分析 id\nid值越大，先执行\nid值相同，从上往下执行\n"><meta property='og:url' content='https://yuxiay.github.io/p/sql%E4%BC%98%E5%8C%96%E4%B8%8E%E9%94%81%E6%9C%BA%E5%88%B6/'><meta property='og:site_name' content='yuxiay的博客'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='mysql'><meta property='article:published_time' content='2024-12-23T18:04:06+08:00'><meta property='article:modified_time' content='2024-12-23T18:04:06+08:00'><meta name=twitter:title content="SQL优化与锁机制"><meta name=twitter:description content="SQL优化与锁机制 SQL优化 通过SQL语句前加入explain进行分析\n1 explain + 正常sql语句 explain内容分析：\nexplain结构分析 id\nid值越大，先执行\nid值相同，从上往下执行\n"><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_b33ac33d040797db.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>🍥</span></figure><div class=site-meta><h1 class=site-name><a href=/>yuxiay的博客</a></h1><h2 class=site-description>偷得浮生半日闲</h2></div></header><ol class=menu-social><li><a href=https://github.com target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com target=_blank title=Twitter rel=me><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#sql优化>SQL优化</a><ol><li><a href=#explain结构分析>explain结构分析</a></li><li><a href=#优化实例>优化实例</a></li><li><a href=#profiles分析海量数据>profiles分析海量数据</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/mysql/>Mysql</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/sql%E4%BC%98%E5%8C%96%E4%B8%8E%E9%94%81%E6%9C%BA%E5%88%B6/>SQL优化与锁机制</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Dec 23, 2024</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 6 分钟</time></div></footer></div></header><section class=article-content><h1 id=sql优化与锁机制>SQL优化与锁机制</h1><h2 id=sql优化>SQL优化</h2><p>通过SQL语句前加入explain进行分析</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>explain + 正常sql语句
</span></span></code></pre></td></tr></table></div></div><p>explain内容分析：</p><p><img src=/p/sql%E4%BC%98%E5%8C%96%E4%B8%8E%E9%94%81%E6%9C%BA%E5%88%B6/image-20250416184440434.png width=1035 height=135 srcset="/p/sql%E4%BC%98%E5%8C%96%E4%B8%8E%E9%94%81%E6%9C%BA%E5%88%B6/image-20250416184440434_hu_b782858e413b8043.png 480w, /p/sql%E4%BC%98%E5%8C%96%E4%B8%8E%E9%94%81%E6%9C%BA%E5%88%B6/image-20250416184440434_hu_988fb3ae4c1f6a16.png 1024w" loading=lazy alt=image-20250416184440434 class=gallery-image data-flex-grow=766 data-flex-basis=1840px></p><h3 id=explain结构分析>explain结构分析</h3><p><strong>id</strong></p><ul><li><p>id值越大，先执行</p></li><li><p>id值相同，从上往下执行</p></li><li><p>影响行数根据影响行数从小到大</p></li></ul><p><strong>select_type</strong></p><p><img src=/p/sql%E4%BC%98%E5%8C%96%E4%B8%8E%E9%94%81%E6%9C%BA%E5%88%B6/image-20250416185251454.png width=1048 height=178 srcset="/p/sql%E4%BC%98%E5%8C%96%E4%B8%8E%E9%94%81%E6%9C%BA%E5%88%B6/image-20250416185251454_hu_de601a18e68cbe17.png 480w, /p/sql%E4%BC%98%E5%8C%96%E4%B8%8E%E9%94%81%E6%9C%BA%E5%88%B6/image-20250416185251454_hu_4955c11020ccd430.png 1024w" loading=lazy alt=image-20250416185251454 class=gallery-image data-flex-grow=588 data-flex-basis=1413px></p><ul><li><p>PRIMARY:包含子查询SQL中的主查询（最外层）</p></li><li><p>SUBQUERY:包含子查询SQL中的子查询（非最外层）</p></li><li><p>SIMPLE:简单查询（不包含子查询，union）</p></li><li><p>DERIVED:衍生查询（使用到了临时表）</p><ul><li><p>在from子查询中只有一张表</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>explain</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=n>cr</span><span class=p>.</span><span class=n>cname</span><span class=w> </span><span class=k>from</span><span class=p>(</span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>course</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>tid</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>))</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>在from子查询中，如果有table union table2，则table1就是derived</p></li></ul></li></ul><p><strong>type</strong></p><p>索引类型</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>system</span><span class=o>&gt;</span><span class=k>const</span><span class=o>&gt;</span><span class=n>eq_ref</span><span class=o>&gt;</span><span class=n>ref</span><span class=o>&gt;</span><span class=nb>range</span><span class=o>&gt;</span><span class=n>index</span><span class=o>&gt;</span><span class=n>all</span>
</span></span><span class=line><span class=cl><span class=err>其中：</span><span class=n>system</span><span class=err>，</span><span class=n>const只是理想情况</span><span class=err>，实际上能达到</span><span class=n>ref</span><span class=o>&gt;</span><span class=nb>range</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><p>system:只有一条数据的系统表或衍生表，只有一条数据的主查询</p></li><li><p>const：仅仅能查到一条数据的SQL，用于Primary key 或 unique索引</p></li><li><p>eq_ref：唯一索引，结果多条数据，但每条数据是唯一的</p></li><li><p>ref：非唯一索引，对于每个索引键的查询，返回匹配的所有行（0，多）</p></li><li><p>range:检索指定范围的行，where后面是一个范围查询（between，> &lt; >=, in特殊）</p></li><li><p>index：查询全部索引中的数据</p></li><li><p>all：查询全部表中的数据</p></li></ul><p><strong>possible_keys</strong></p><p>可能用到的索引，是一种预测，不准</p><p>如果是NULL则无索引</p><p><strong>key</strong></p><p>实际用到的索引</p><p>如果是NULL则无索引</p><p><strong>key_lens</strong></p><p>索引的长度</p><p>作用：用于判断复合索引是否被完全使用</p><p>ut8默认一个字符3个字节</p><p>如果可以为空则+1，如果是varchar再+2</p><p><strong>ref</strong></p><p>注意：与tepe中ref区分</p><p>作用：指明当前表所参照的字段(b.x)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>explain</span> <span class=n>select</span> <span class=o>...</span> <span class=n>where</span> <span class=n>a</span><span class=o>.</span><span class=n>c</span> <span class=o>=</span> <span class=n>b</span><span class=o>.</span><span class=n>x</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=err>其中</span><span class=p>(</span><span class=n>b</span><span class=o>.</span><span class=n>x</span><span class=p>)</span><span class=err>可以是常量，</span><span class=k>const</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=/p/sql%E4%BC%98%E5%8C%96%E4%B8%8E%E9%94%81%E6%9C%BA%E5%88%B6/image-20250416190552617.png width=1042 height=225 srcset="/p/sql%E4%BC%98%E5%8C%96%E4%B8%8E%E9%94%81%E6%9C%BA%E5%88%B6/image-20250416190552617_hu_25d3ab20fe3ef2f.png 480w, /p/sql%E4%BC%98%E5%8C%96%E4%B8%8E%E9%94%81%E6%9C%BA%E5%88%B6/image-20250416190552617_hu_6cb55b3d06fc3396.png 1024w" loading=lazy alt=image-20250416190552617 class=gallery-image data-flex-grow=463 data-flex-basis=1111px></p><p><strong>rows</strong></p><p>被索引优化查询的数据个数(实际通过索引查询到的数据个数)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>select * from course c.teacher t where c.tid = t.tid
</span></span></code></pre></td></tr></table></div></div><p><img src=/p/sql%E4%BC%98%E5%8C%96%E4%B8%8E%E9%94%81%E6%9C%BA%E5%88%B6/image-20250416190817544.png width=1018 height=159 srcset="/p/sql%E4%BC%98%E5%8C%96%E4%B8%8E%E9%94%81%E6%9C%BA%E5%88%B6/image-20250416190817544_hu_f617e911945ceb5c.png 480w, /p/sql%E4%BC%98%E5%8C%96%E4%B8%8E%E9%94%81%E6%9C%BA%E5%88%B6/image-20250416190817544_hu_379059a05bba8fdd.png 1024w" loading=lazy alt=image-20250416190817544 class=gallery-image data-flex-grow=640 data-flex-basis=1536px></p><p><strong>Extra</strong></p><ul><li>using filesort:性能消耗比较大；需要“额外”一次排序（查询）常见于order by语句</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>explain select * from test02 where a1 = &#39;&#39; order by a2;  --using filesort
</span></span><span class=line><span class=cl>小结：对于单索引，如果排序和查找是同一个字段，则不会出现using filesort
</span></span><span class=line><span class=cl>避免：where哪些字段，就order by哪些字段 	 
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>alter table test02 add index idx_a1_a2_a3 (a1,a2,a3);
</span></span><span class=line><span class=cl>explain select * from test02 where a1 = &#39;&#39; order by a3;  --using filesort
</span></span><span class=line><span class=cl>小结：对于复合索引不能跨列（最佳左前缀）
</span></span><span class=line><span class=cl>避免：按照复合索引的顺序使用，不要跨列或无序使用（where和order by拼起来）
</span></span></code></pre></td></tr></table></div></div><ul><li><p>using temporary:性能损耗大，用到了临时表，一般出现在group by语句中</p></li><li><p>using index:性能提升；索引覆盖。</p></li></ul><p>​ 原因：不读取原文件，只从索引文件中查询数据（不需要回表查询）</p><p>​ using index时，会对possible_keys和key造成影响：</p><p>​ 1.如果没有where，则索引只出现在key中</p><p>​ 2.如果有where，则索引出现在key和possible_key中</p><ul><li>using where(需要回表查询)</li><li>impossible where</li></ul><p>​ where子句永远为false</p><h3 id=优化实例>优化实例</h3><p><strong>第一个简单例子</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>create table test03(
</span></span><span class=line><span class=cl>	a1 int(4) not null,
</span></span><span class=line><span class=cl>	a2 int(4) not null,
</span></span><span class=line><span class=cl>	a3 int(4) not null,
</span></span><span class=line><span class=cl>	a4 int(4) not null,
</span></span><span class=line><span class=cl>);
</span></span><span class=line><span class=cl>alter table test03 add index idx_a1_a2_a3_a4(a1,a2,a3,a4)
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>explain select a1,a2,a3,a4 from test03 where a1=1 and a2=2 and a3=3 and a4=4;		--推荐写法 using index
</span></span><span class=line><span class=cl>explain select a1,a2,a3,a4 from test03 where a4=1 and a3=2 and a2=3 and a1=4;		--虽然编写顺序和索引顺序不一致，但是sql在真正执行前经过了sql优化器的调整，结果与上述是一致的
</span></span><span class=line><span class=cl>explain select a1,a2,a3,a4 from test03 where a1=1 and a2=2 and a4=4 order by a3;	--以上sql用到了俩个索引a1,a2,该俩个字段不需要回表查询using index,a4需要回表查询
</span></span></code></pre></td></tr></table></div></div><p>总结：</p><ul><li><p>如果（abcd）复合索引和使用的顺序全部一致（且不跨列使用），则复合索引全部使用，如果部分一致，则使用部分索引</p></li><li><p>where和order by拼起来，不要跨列使用</p></li></ul><p><strong>单表优化</strong></p><ol><li>加索引 根据SQL解析顺便，来调整索引顺序，先解析where后解析select 索引一旦进行升级优化，需要将之前废弃索引删掉</li><li>最佳左前缀，保持索引的定义和使用的顺序一致性</li><li>将包含in的查询放到最后</li></ol><p><strong>多表优化</strong></p><ul><li>当编写 <code>on t.cid=c.tid</code> 时，将数据量小的表放左边（假设t表小）</li><li>索引往哪个表加？&ndash;小表驱动大表 &ndash;索引建立在经常使用的字段上</li><li>一般情况，对于左外连接给左表加索引，对于右外连接给右表加索引</li></ul><p><strong>避免索引失效的一些原则</strong></p><ul><li>复合索引，不要跨列或无序使用（最佳左前缀）</li><li>复合索引，尽量使用全索引匹配</li><li>不要在索引上进行任何操作（计算，函数，类型转换），否则索引失效，对于复合索引，如果左边失效，则右边全部失效</li><li>复合索引不能使用不等于或<code>is null</code>,否则自身及右侧全部失效</li><li>复合索引中如果有范围查询（>,&lt;,in），则右侧索引全部失效（概率情况）</li><li>尽量使用索引覆盖（using index）,不会出现概率情况</li><li>like尽量以常量开头，不要以%开头，否则索引失效（using index情况下不会失效）</li><li>尽量不要使用类型转换（显示，隐式），否则都会使索引失效</li><li>尽量不要使用or，否则索引失效</li></ul><p><strong>一些其它优化方法</strong></p><ul><li>exist和in<ul><li>如果主查询的数据集大，则使用In</li><li>如果子查询的数据集大，则使用exist</li></ul></li><li>order by 优化<ul><li>单路排序：只读取一次（全部字段），在buffer中进行排序。但此种单路排序会有一定隐患，不一定真的是单路，可能会多次IO</li><li>提高order by查询策略：<ul><li>选择使用单路，双路，调整buffer容量大小</li><li>避免select *</li><li>复合索引，不要跨列使用，避免using filesort</li><li>保证全部的排序字段排序一致性（都是升序或排序）</li></ul></li></ul></li></ul><p><strong>SQL排查&ndash;慢查询日志</strong></p><p>MySQL提供的一种日志记录，用于记录MySQL中相应时间超过阈值的SQL语句（long_query_time,默认10秒）</p><p>慢查询日志默认是关闭的；建议开发调优时打开，而最终部署时关闭</p><p>检查是否开启了慢查询日志: <code>show variables like '%slow_query_log';</code></p><p>开启慢查询日志：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=err>临时开启：</span>
</span></span><span class=line><span class=cl><span class=n>set</span> <span class=n>global</span> <span class=n>slow_query_log</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>	<span class=err>在内存中开启</span>
</span></span><span class=line><span class=cl><span class=n>exit</span>
</span></span><span class=line><span class=cl><span class=n>service</span> <span class=n>mysql</span> <span class=n>restart</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>永久开启：</span>
</span></span><span class=line><span class=cl><span class=o>/</span><span class=n>etc</span><span class=o>/</span><span class=n>my</span><span class=o>.</span><span class=n>cnf</span> <span class=err>中追加配置</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>mysqld</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>slow_query_log</span><span class=o>=</span><span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=n>slow_query_log_file</span><span class=o>=/</span><span class=k>var</span><span class=o>/</span><span class=n>lib</span><span class=o>/</span><span class=n>mysql</span><span class=o>/</span><span class=n>localhost</span><span class=o>-</span><span class=n>slow</span><span class=o>.</span><span class=n>log</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>慢查询阈值：</span>
</span></span><span class=line><span class=cl><span class=n>show</span> <span class=n>variables</span> <span class=n>like</span> <span class=s1>&#39;</span><span class=si>%lo</span><span class=s1>ng_query_time%&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=err>临时设置阈值：</span>
</span></span><span class=line><span class=cl><span class=n>set</span> <span class=n>global</span> <span class=n>long_query_time</span> <span class=o>=</span> <span class=mi>5</span><span class=p>;</span>		<span class=o>--</span><span class=err>设置完毕后不会立刻生效，需要重新登陆后才能生效</span>
</span></span><span class=line><span class=cl><span class=err>永久设置阈值：</span>
</span></span><span class=line><span class=cl><span class=o>/</span><span class=n>etc</span><span class=o>/</span><span class=n>my</span><span class=o>.</span><span class=n>cnf</span> <span class=err>中追加配置</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>mysqld</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>long_query_time</span><span class=o>=</span><span class=mi>3</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>查询超过阈值的SQL：
</span></span><span class=line><span class=cl>show global status like &#39;%slow_queries&#39;;
</span></span></code></pre></td></tr></table></div></div><p>慢查询的SQL被记录在日志中，因此可以通过日志来查看具体的慢SQL
查看上述的日志文件即可</p><p>通过mysqldumpslow工具查看慢SQL,可以通过一些过滤条件 快速查找需要定位的慢SQL</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>mysqldumpslow --help
</span></span><span class=line><span class=cl>s: 排序方式
</span></span><span class=line><span class=cl>r: 逆序
</span></span><span class=line><span class=cl>l: 锁定时间
</span></span><span class=line><span class=cl>g: 正则匹配模式
</span></span></code></pre></td></tr></table></div></div><p>获取返回记录最多的三个SQL</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>mysqldumpslow</span> <span class=o>-</span><span class=n>s</span> <span class=n>r</span> <span class=o>-</span><span class=n>t</span> <span class=mi>3</span> <span class=o>/</span><span class=k>var</span><span class=o>/</span><span class=n>lib</span><span class=o>/</span><span class=n>mysql</span><span class=o>/</span><span class=n>localhost</span><span class=o>-</span><span class=n>slow</span><span class=o>.</span><span class=n>log</span>
</span></span></code></pre></td></tr></table></div></div><p>获取访问次数最多的3个SQL</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>mysqldumpslow</span> <span class=o>-</span><span class=n>s</span> <span class=n>c</span> <span class=o>-</span><span class=n>t</span> <span class=mi>3</span> <span class=o>/</span><span class=k>var</span><span class=o>/</span><span class=n>lib</span><span class=o>/</span><span class=n>mysql</span><span class=o>/</span><span class=n>localhost</span><span class=o>-</span><span class=n>slow</span><span class=o>.</span><span class=n>log</span>
</span></span></code></pre></td></tr></table></div></div><p>按照时间排序，前10条包含<code>left join</code>查询语句的SQL</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>mysqldumpslow</span> <span class=o>-</span><span class=n>s</span> <span class=n>t</span> <span class=o>-</span><span class=n>t</span> <span class=mi>10</span> <span class=o>-</span><span class=n>g</span> <span class=s2>&#34;left join&#34;</span> <span class=o>/</span><span class=k>var</span><span class=o>/</span><span class=n>lib</span><span class=o>/</span><span class=n>mysql</span><span class=o>/</span><span class=n>localhost</span><span class=o>-</span><span class=n>slow</span><span class=o>.</span><span class=n>log</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=profiles分析海量数据>profiles分析海量数据</h3><p><code>show profiles</code> &ndash;默认关闭</p><p><code>show variables like '%profiling%';</code></p><p><code>set profiling = on;</code></p><p><code>show profiles;</code>会记录所有 <code>profiling</code>打开之后的 全部查询语句所花费的时间。缺点：不够精确</p><p>&mdash; 精确分析：sql诊断</p><p><code>show profile all for query Query_Id</code>上一步查询到的Query_Id</p><p><code>show profile cpu blockio for query Query_Id</code></p><p>​</p></section><footer class=article-footer><section class=article-tags><a href=/tags/mysql/>Mysql</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//hugo-theme-stack.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2025 yuxiay的博客</section><section class=powerby>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>